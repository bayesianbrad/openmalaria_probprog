% !TEX root = notes.tex

\tikzset{
    state/.style={
           rectangle,
           rounded corners,
           draw=black, very thick,
           minimum height=2em,
           inner sep=2pt,
           text centered,
           },
}

\begin{figure}
\begin{tikzpicture}[->,>=stealth']

 % Position of Sample 
 % Use previously defined 'state' as layout (see above)
 % use tabular for content to get columns/rows
 % parbox to limit width of the listing
 \node[state,
 text width=3cm, 	% max text width
 yshift=0cm, 		% move 2cm in y
 node distance=0cm, 	% distance to Sample
 anchor=center,
 fill=purple] (Sample) 
{%
\begin{tabular}{l} 	% content
  \textcolor{white}{\textbf{Sample}}\\
  \parbox{4cm}{
  \textcolor{white}{\small{Program call:\\
  \emph{Program}.\texttt{forward()}}}
 }
 \end{tabular}};
  
 \node[state,    	% layout (defined above)
 text width=3cm, 	% max text width
 yshift=-2cm, 		% move 2cm in y
 below of=Sample, 	% Position is to the right of Sample
 node distance=0cm, 	% distance to Sample
 anchor=center,
 fill= purple] (OBSERVE) 	% posistion relative to the center of the 'box'
{%
\begin{tabular}{l} 	% content
  \textcolor{white}{\textbf{Observe}}\\
 \parbox{4cm}{
  \textcolor{white}{\small{Program call:\\
  \emph{Program}.\texttt{forward()}}}
}
\end{tabular}};

 % State: PyProb with different content
 \node[state,    	% layout (defined above)
  text width=3cm, 	% max text width
  yshift=0cm, 		% move 2cm in y
  right of=Sample, 	% Position is to the right of Sample
  node distance=6.5cm, 	% distance to Sample
  anchor=center,
  fill = black!50!green] (PyProb) 	% posistion relative to the center of the 'box'
 {%
 \begin{tabular}{l} 	% content
  \textcolor{white}{\textbf{System}}\\ %system sample
  \parbox{4cm}{\textcolor{white}{Pyprob processes\\ \texttt{sample}}}
 \end{tabular}
 };
 
 % STATE System
 \node[state,
  below of=PyProb,
  yshift=-1cm,
  anchor=center,
  text width=3cm,
  fill = black!50!green] (System) 
 {%
 \begin{tabular}{l}
  \textcolor{white}{\textbf{System}}\\
  \parbox{4cm}{\textcolor{white}{Pyprob processes \\\texttt{observe}}}
 \end{tabular}
 };

 % STATE EPC
 \node[state,
  right of=System,
  yshift = 1cm,
  node distance=5cm,
  anchor=center] (EPC) 
 {%
 \begin{tabular}{l}
  \textbf{Program density}\\
  \parbox{5cm}{P($\mathcal{T}= x_{1:n_x}| \lambda)$\\
  \{$x_{1:n_{x}}\}$,$w= \prod^{n_{y}}_{i=1} g_{b_i}(y_i | \psi_i)$}
 \end{tabular}
 };


  % STATE OUTPUT
  \node[state,
  above of=EPC,
  yshift = -1cm,
  node distance=5cm,
  anchor=center] (OUTPUT) 
 {%
 \begin{tabular}{l}
  \textbf{Program Output}\\
  \parbox{5cm}{$\Omega = \{P_{r}(x_{1:n_{x}}), w\}$}
 \end{tabular}
 };

 % draw the paths and and print some Text below/above the graph
 \path (Sample) 	edge[bend left=20]  node[anchor=south,above]{$f_{a_{j}} ; \eta_{j}$}(PyProb)
 (OBSERVE)     	edge[bend right=20] node[anchor=south,above]{$g_{b_{i}},\phi_i , y_i $} (System)
 (System)       	edge [bend right=20] node[anchor=south,below]{$g_{b_{i}}(y_i, \phi_i)$} (EPC)
 (PyProb)       edge [bend left=9] node[anchor=west, above]{$x_{i}$} (Sample)
 (PyProb)       edge [bend left=9] node[anchor=west, above]{$x_{i}$} (EPC)
%  (System)       	edge [bend left=10]                                          (EPC)
 (EPC)              edge                                                    (OUTPUT)
 (System)  	edge [bend right=10]  node[anchor=north,above]{\emph{Control}} (OBSERVE)
 (Sample)   edge [bend left= 20] (OUTPUT) ;
%  (System)  	edge[loop below]    node[anchor=north,below]{$SC_n\neq 0$} (System)
%  (System)  	edge                node[anchor=left,right]{$SC_n = 0$} (PyProb);

\end{tikzpicture}
\caption{An overview of the hijacking system. $x_i$ represent latent variables. $f_{a_i}$ represent raw sample calls,
$g_{b_j}$ represent conditioning statements. $\mathcal{T}$ corresponds to the program trace. $w$ represents the collective weights. 
$r$ represents run number. $n_x$ represents the number of latent variables and $n_y$ represents the number of
observations, which will always be fixed, but is model dependent. $\lambda$ represents all the other variables generated 
by running the simulator \texttt{.forward()}.
}
\label{fig:systemoverview}
\end{figure}